<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTZ 云台控制系统 (Web)</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; background-color: #f8f9fa; }
        .card-header { font-weight: bold; background-color: #e9ecef; }
        .log-area { 
            height: 300px; 
            overflow-y: scroll; 
            background: #fff; 
            border: 1px solid #ced4da; 
            padding: 10px; 
            font-family: monospace; 
            font-size: 0.9em;
        }
        .config-section { margin-bottom: 15px; border: 1px solid #dee2e6; padding: 10px; border-radius: 5px; }
        .btn-control { margin: 0 5px; }

        /* --- 仪表盘样式 --- */
        .gauge-container { display: flex; justify-content: space-around; align-items: flex-end; padding: 20px 0; }
        .az-compass {
            width: 120px; height: 120px;
            border: 4px solid #555;
            border-radius: 50%;
            position: relative;
            background: #fff;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        .az-compass::after { content: 'N'; position: absolute; top: 2px; left: 50%; transform: translateX(-50%); font-size: 10px; color: #999; }
        .az-needle {
            width: 4px; height: 50%; background: red; position: absolute; left: 50%; top: 0;
            margin-left: -2px; transform-origin: bottom center; transition: transform 0.5s cubic-bezier(0.4, 2.08, 0.55, 0.44);
            border-radius: 2px; z-index: 10;
        }
        .az-needle::after { content: ''; position: absolute; bottom: -5px; left: -3px; width: 10px; height: 10px; background: #333; border-radius: 50%; }
        .el-gauge {
            width: 40px; height: 150px; border: 2px solid #555; background: #eee; position: relative; border-radius: 4px;
        }
        .el-bar {
            width: 100%; background: linear-gradient(to top, #0d6efd, #0dcaf0); position: absolute; bottom: 0; left: 0;
            height: 0%; transition: height 0.5s ease-out;
        }
        .el-label-min, .el-label-max { position: absolute; left: 45px; font-size: 12px; color: #666; width: 50px; }
        .el-label-max { top: -8px; }
        .el-label-min { bottom: -8px; }
    </style>
</head>
<body>

<div class="container-fluid" style="max-width: 1200px;">
    <h3 class="mb-4">PTZ 云台控制系统</h3>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-3">
                <div class="card-header">设备配置</div>
                <div class="card-body">
                    
                    <div class="config-section">
                        <h5>GS232B (本机模拟)</h5>
                        <div class="row g-2 align-items-center">
                            <div class="col-auto"><label>协议:</label></div>
                            <div class="col-auto">
                                <select class="form-select form-select-sm" id="gs232_proto" onchange="toggleProto('gs232')">
                                    <option value="serial">串口</option>
                                    <option value="tcp">TCP</option>
                                </select>
                            </div>
                            
                            <div class="col-auto proto-serial gs232-serial"><label>端口:</label></div>
                            <div class="col-auto proto-serial gs232-serial">
                                <select class="form-select form-select-sm port-select" id="gs232_port"></select>
                            </div>
                            <div class="col-auto proto-serial gs232-serial"><label>波特率:</label></div>
                            <div class="col-auto proto-serial gs232-serial">
                                <select class="form-select form-select-sm" id="gs232_baud">
                                    <option>9600</option><option>19200</option><option>115200</option>
                                </select>
                            </div>

                            <div class="col-auto proto-tcp gs232-tcp" style="display:none"><label>Host:</label></div>
                            <div class="col-auto proto-tcp gs232-tcp" style="display:none">
                                <input type="text" class="form-control form-control-sm" id="gs232_host" placeholder="0.0.0.0" style="width: 120px;">
                            </div>
                            <div class="col-auto proto-tcp gs232-tcp" style="display:none"><label>Port:</label></div>
                            <div class="col-auto proto-tcp gs232-tcp" style="display:none">
                                <input type="number" class="form-control form-control-sm" id="gs232_tcp_port" placeholder="4000" style="width: 80px;">
                            </div>
                        </div>
                    </div>

                    <div class="config-section">
                        <h5>PELCO (云台设备)</h5>
                        <div class="row g-2 align-items-center mb-2">
                            <div class="col-auto"><label>协议:</label></div>
                            <div class="col-auto">
                                <select class="form-select form-select-sm" id="pelco_proto" onchange="toggleProto('pelco')">
                                    <option value="serial">串口</option>
                                    <option value="tcp">TCP</option>
                                </select>
                            </div>

                            <div class="col-auto proto-serial pelco-serial"><label>端口:</label></div>
                            <div class="col-auto proto-serial pelco-serial">
                                <select class="form-select form-select-sm port-select" id="pelco_port"></select>
                            </div>
                            <div class="col-auto proto-serial pelco-serial"><label>波特率:</label></div>
                            <div class="col-auto proto-serial pelco-serial">
                                <select class="form-select form-select-sm" id="pelco_baud">
                                    <option>2400</option><option>9600</option>
                                </select>
                            </div>

                            <div class="col-auto proto-tcp pelco-tcp" style="display:none"><label>Host:</label></div>
                            <div class="col-auto proto-tcp pelco-tcp" style="display:none">
                                <input type="text" class="form-control form-control-sm" id="pelco_host" placeholder="192.168.x.x" style="width: 120px;">
                            </div>
                            <div class="col-auto proto-tcp pelco-tcp" style="display:none"><label>Port:</label></div>
                            <div class="col-auto proto-tcp pelco-tcp" style="display:none">
                                <input type="number" class="form-control form-control-sm" id="pelco_tcp_port" placeholder="23" style="width: 80px;">
                            </div>
                        </div>

                        <div class="row g-2">
                            <div class="col-3"><small>Min EL:</small><input type="number" class="form-control form-control-sm" id="min_el" onchange="updateGaugeRange()"></div>
                            <div class="col-3"><small>Max EL:</small><input type="number" class="form-control form-control-sm" id="max_el" onchange="updateGaugeRange()"></div>
                            <div class="col-3"><small>AZ Offset:</small><input type="number" class="form-control form-control-sm" id="az_offset"></div>
                            <div class="col-3"><small>Init AZ:</small><input type="number" class="form-control form-control-sm" id="init_az"></div>
                        </div>
                    </div>

                    <div class="config-section bg-light">
                        <h5>1602 LCD 设置</h5>
                        <div class="row g-2 align-items-center">
                            <div class="col-auto">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="lcd_enabled" onchange="toggleLCD()">
                                    <label class="form-check-label" for="lcd_enabled">启用LCD</label>
                                </div>
                            </div>
                            <div class="col-auto"><label>I2C地址:</label></div>
                            <div class="col-auto"><input type="text" class="form-control form-control-sm" id="lcd_address" placeholder="0x27" value="0x27"></div>
                        </div>
                    </div>

                    <div class="config-section border-primary">
                        <h5>AZ/EL 手动调整</h5>
                        <div class="row g-2 mb-2">
                            <div class="col-auto"><label>水平角度:</label></div>
                            <div class="col"><input type="number" class="form-control form-control-sm" id="manual_az"></div>
                            <div class="col-auto"><button class="btn btn-sm btn-primary" onclick="setAngle(0x4B)">执行</button></div>
                        </div>
                        <div class="row g-2">
                            <div class="col-auto"><label>俯仰角度:</label></div>
                            <div class="col"><input type="number" class="form-control form-control-sm" id="manual_el"></div>
                            <div class="col-auto"><button class="btn btn-sm btn-primary" onclick="setAngle(0x4D)">执行</button></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mb-3">
                <button id="btn-start" class="btn btn-success btn-control" onclick="toggleSystem()">启动系统</button>
                <button class="btn btn-warning btn-control" onclick="clearLog()">清除日志</button>
                <button class="btn btn-primary btn-control" onclick="saveConfig()">保存配置</button>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card mb-3 border-info">
                <div class="card-header bg-info text-white">状态调试视图</div>
                <div class="card-body">
                    <div class="gauge-container">
                        <div class="text-center">
                            <div class="az-compass"><div class="az-needle" id="gauge-az-needle"></div></div>
                            <div class="mt-2 fw-bold" id="gauge-az-val">AZ: 0°</div>
                        </div>
                        <div class="text-center" style="margin-left: 20px;">
                            <div class="el-gauge">
                                <div class="el-label-max" id="gauge-el-max">90</div>
                                <div class="el-bar" id="gauge-el-bar"></div>
                                <div class="el-label-min" id="gauge-el-min">0</div>
                            </div>
                            <div class="mt-2 fw-bold" id="gauge-el-val">EL: 0°</div>
                        </div>
                    </div>
                    <div class="text-muted small text-center mt-2">* 数据源自回传日志分析</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">系统日志</div>
                <div class="card-body p-0">
                    <div id="log-container" class="log-area" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let isRunning = false;
    let minEl = 0;
    let maxEl = 90;

    window.onload = async function() {
        startLogStream();
        await loadPorts();
        await loadConfig();
        await checkSystemStatus(); // <--- 新增这一行
    };

    async function loadPorts() {
        try {
            const res = await fetch('/api/serial_ports');
            const ports = await res.json();
            document.querySelectorAll('.port-select').forEach(sel => {
                const currentVal = sel.value;
                sel.innerHTML = ports.map(p => `<option value="${p}">${p}</option>`).join('');
                if (currentVal && ports.includes(currentVal)) sel.value = currentVal;
            });
        } catch (e) { console.error("加载端口失败", e); }
    }

    async function loadConfig() {
        const res = await fetch('/api/config');
        const cfg = await res.json();
        
        const setSelectValue = (elementId, value) => {
            const el = document.getElementById(elementId);
            if (!el) return;
            let exists = false;
            for (let i = 0; i < el.options.length; i++) {
                if (el.options[i].value == value) { exists = true; break; }
            }
            if (!exists && value) { el.add(new Option(value, value)); }
            el.value = value;
        };

        // --- GS232B 加载 ---
        document.getElementById('gs232_proto').value = cfg.gs232b.protocol;
        toggleProto('gs232'); // 触发UI切换
        
        // 串口参数
        if(cfg.gs232b.serial) {
            setSelectValue('gs232_port', cfg.gs232b.serial.port);
            document.getElementById('gs232_baud').value = cfg.gs232b.serial.baudrate;
        }
        // TCP参数 (修复：添加加载逻辑)
        if(cfg.gs232b.tcp) {
            document.getElementById('gs232_host').value = cfg.gs232b.tcp.host || "";
            document.getElementById('gs232_tcp_port').value = cfg.gs232b.tcp.port || "";
        }

        // --- Pelco 加载 ---
        document.getElementById('pelco_proto').value = cfg.pelco.protocol;
        toggleProto('pelco'); // 触发UI切换
        
        // 串口参数
        if(cfg.pelco.serial) {
            setSelectValue('pelco_port', cfg.pelco.serial.port);
            document.getElementById('pelco_baud').value = cfg.pelco.serial.baudrate;
        }
        // TCP参数 (修复：添加加载逻辑)
        if(cfg.pelco.tcp) {
            document.getElementById('pelco_host').value = cfg.pelco.tcp.host || "";
            document.getElementById('pelco_tcp_port').value = cfg.pelco.tcp.port || "";
        }

        // 角度修正
        document.getElementById('min_el').value = cfg.pelco.angle_correction.min_elevation;
        document.getElementById('max_el').value = cfg.pelco.angle_correction.max_elevation;
        document.getElementById('az_offset').value = cfg.pelco.angle_correction.azimuth_offset;
        document.getElementById('init_az').value = cfg.pelco.angle_correction.initial_azimuth;

        // LCD
        if (cfg.lcd) {
            document.getElementById('lcd_enabled').checked = cfg.lcd.enabled;
            document.getElementById('lcd_address').value = cfg.lcd.address;
        }
        
        updateGaugeRange();
    }

    async function saveConfig() {
        // 构建 GS232 配置 (修复：根据协议类型保存不同参数)
        const gs232Proto = document.getElementById('gs232_proto').value;
        let gs232Config = { protocol: gs232Proto };
        if (gs232Proto === 'serial') {
            gs232Config.serial = {
                port: document.getElementById('gs232_port').value,
                baudrate: parseInt(document.getElementById('gs232_baud').value)
            };
        } else {
            gs232Config.tcp = {
                host: document.getElementById('gs232_host').value,
                port: parseInt(document.getElementById('gs232_tcp_port').value)
            };
        }

        // 构建 Pelco 配置 (修复：根据协议类型保存不同参数)
        const pelcoProto = document.getElementById('pelco_proto').value;
        let pelcoConfig = { 
            protocol: pelcoProto,
            angle_correction: {
                min_elevation: parseFloat(document.getElementById('min_el').value),
                max_elevation: parseFloat(document.getElementById('max_el').value),
                azimuth_offset: parseFloat(document.getElementById('az_offset').value),
                initial_azimuth: parseFloat(document.getElementById('init_az').value)
            }
        };
        if (pelcoProto === 'serial') {
            pelcoConfig.serial = {
                port: document.getElementById('pelco_port').value,
                baudrate: parseInt(document.getElementById('pelco_baud').value)
            };
        } else {
            pelcoConfig.tcp = {
                host: document.getElementById('pelco_host').value,
                port: parseInt(document.getElementById('pelco_tcp_port').value)
            };
        }

        const config = {
            gs232b: gs232Config,
            pelco: pelcoConfig,
            lcd: {
                enabled: document.getElementById('lcd_enabled').checked,
                address: document.getElementById('lcd_address').value
            },
            ui: { topmost: false }
        };

        try {
            const res = await fetch('/api/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(config)
            });
            if(res.ok) alert('配置已保存');
            else alert('配置保存失败');
        } catch(e) { alert('保存配置时发生错误: ' + e); }
    }


    async function checkSystemStatus() {
        try {
            const res = await fetch('/api/system/status');
            const data = await res.json();
            
            // 如果后端正在运行，强制同步前端状态
            if (data.running) {
                isRunning = true;
                const btn = document.getElementById('btn-start');
                if (btn) {
                    btn.innerText = '停止系统';
                    btn.classList.replace('btn-success', 'btn-danger');
                }
            } else {
                // 如果后端没运行，确保前端也是停止状态 (通常默认就是，但也防万一)
                isRunning = false;
                const btn = document.getElementById('btn-start');
                if (btn) {
                    btn.innerText = '启动系统';
                    btn.classList.replace('btn-danger', 'btn-success');
                }
            }
        } catch (e) {
            console.error("无法获取系统状态", e);
        }
    }


    async function toggleSystem() {
        const action = isRunning ? 'stop' : 'start';
        const btn = document.getElementById('btn-start');
        const res = await fetch('/api/system/toggle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: action})
        });
        const data = await res.json();
        
        if (data.status === 'started') {
            isRunning = true;
            btn.innerText = '停止系统';
            btn.classList.replace('btn-success', 'btn-danger');
        } else if (data.status === 'stopped') {
            isRunning = false;
            btn.innerText = '启动系统';
            btn.classList.replace('btn-danger', 'btn-success');
        } else if (data.status === 'error') {
            alert("错误: " + data.message);
        }
    }

    async function setAngle(type) {
        const id = type === 0x4B ? 'manual_az' : 'manual_el';
        const val = document.getElementById(id).value;
        if (!val) return;
        await fetch('/api/control/set_angle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({angle: val, type: type})
        });
    }

    async function toggleLCD() {
        const checkbox = document.getElementById('lcd_enabled');
        const address = document.getElementById('lcd_address').value;
        const enabled = checkbox.checked;
        try {
            const res = await fetch('/api/lcd/toggle', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({enabled: enabled, address: address})
            });
            const data = await res.json();
            if (res.status !== 200) {
                alert(data.message || "操作失败");
                checkbox.checked = false; 
            }
        } catch (e) {
            alert("通信错误");
            checkbox.checked = !enabled;
        }
    }

    function clearLog() {
        document.getElementById("log-container").innerHTML = "";
        fetch('/api/control/clear_log', {method: 'POST'});
    }

    function toggleProto(dev) {
        const proto = document.getElementById(dev+'_proto').value;
        const serialEls = document.querySelectorAll(`.${dev}-serial`);
        const tcpEls = document.querySelectorAll(`.${dev}-tcp`);
        
        if (proto === 'serial') {
            serialEls.forEach(e => e.style.display = 'block');
            tcpEls.forEach(e => e.style.display = 'none');
        } else {
            serialEls.forEach(e => e.style.display = 'none');
            tcpEls.forEach(e => e.style.display = 'block');
        }
    }

    function updateGaugeRange() {
        minEl = parseFloat(document.getElementById('min_el').value) || 0;
        maxEl = parseFloat(document.getElementById('max_el').value) || 90;
        document.getElementById('gauge-el-min').innerText = minEl;
        document.getElementById('gauge-el-max').innerText = maxEl;
    }

    function startLogStream() {
        const evtSource = new EventSource("/api/logs");
        const logContainer = document.getElementById("log-container");
        
        evtSource.onmessage = function(e) {
            const div = document.createElement("div");
            div.textContent = e.data;
            if(e.data.includes("[错误]")) div.style.color = "red";
            else if(e.data.includes("[命令]")) div.style.color = "blue";
            
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;

            const match = e.data.match(/AZ=(\d+)\s+EL=(\d+)/);
            if (match) {
                updateVisuals(parseInt(match[1]), parseInt(match[2]));
            }
        };
    }

    function updateVisuals(az, el) {
        document.getElementById('gauge-az-val').innerText = `AZ: ${az}°`;
        document.getElementById('gauge-el-val').innerText = `EL: ${el}°`;
        document.getElementById('gauge-az-needle').style.transform = `rotate(${az}deg)`;
        let pct = (el - minEl) / (maxEl - minEl) * 100;
        pct = Math.max(0, Math.min(100, pct));
        document.getElementById('gauge-el-bar').style.height = `${pct}%`;
    }
</script>
</body>
</html>